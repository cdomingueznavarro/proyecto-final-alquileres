<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:p="http://primefaces.prime.com.tr/ui" 
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:comps="http://java.sun.com/jsf/composite/comps" >

    <body>

        <ui:composition template="./../resources/templates/masterPage.xhtml">

            <ui:define name="logInfo">
                <h:form>
                    <h:commandLink value="Inicio" action="inicio.xhtml" />
                </h:form>
            </ui:define>

            <ui:define name="right">
                <comps:loginBox />
            </ui:define>

            <ui:define name="principal">
                <h:outputScript library="javascript" name="util.js" />
                <h:form id="usuarioForm">
                    <h1>Registrar Usuario</h1>

                    <p:panel header="Datos de registro" >
                        <h:panelGrid columns="3">
                            <h:outputLabel value="Email" />
                            <p:inputText id="email" value="#{usuario.email}" required="true"
                                         requiredMessage="Valor requerido" />
                            <p:message id="emailVal" for="email" showSummary="false" />
                            <h:outputLabel value="Usuario" />
                            <p:inputText id="usuario" value="#{usuario.username}" required="true"
                                         requiredMessage="Valor requerido"
                                         validator="#{usuario.validarUsername}">
                                <p:ajax event="blur" update="usuarioVal" />
                            </p:inputText>
                            <p:message id="usuarioVal" for="usuario" />
                            <h:outputLabel value="Contraseña" />
                            <p:password id="password" minLength="8" feedback="true"
                                        value="#{usuario.password}" required="true"
                                        requiredMessage="Valor requerido">
                                <p:ajax event="blur" update="passwordVal" />
                            </p:password>
                            <p:message id="passwordVal" for="password" />
                            <h:outputLabel value="Repita contraseña" />
                            <p:password id="password2" minLength="8" feedback="false" 
                                        value="#{usuario.password2}" required="true" validator="#{usuario.validarPassword}"
                                        requiredMessage="Valor requerido">
                                <p:ajax event="blur" update="password2Val" />
                            </p:password>
                            <p:message id="password2Val" for="password2" />
                        </h:panelGrid>
                    </p:panel>

                    <p:panel header="Datos Personales" >
                        <h:panelGrid columns="3" >
                            <h:outputLabel value="Nombre" />
                            <p:inputText id="nombre" value="#{usuario.nombre}" required="true"
                                         requiredMessage="Valor requerido"/>
                            <p:message for="nombre" />
                            <h:outputLabel value="Apellido" />
                            <p:inputText id="apellido" value="#{usuario.apellido}" required="true"
                                         requiredMessage="Valor requerido"/>
                            <p:message for="apellido" />
                            <h:outputLabel value="DNI" />
                            <p:inputMask id="dni" value="#{usuario.dni}" required="true"
                                         requiredMessage="Valor requerido" mask="99.999.999" />
                            <p:message for="dni" />
                            <h:outputLabel value="Telefono" />
                            <p:inputText id="telefono" value="#{usuario.telefono}" />
                            <p:message for="telefono" />
                            <h:outputLabel value="Fecha Nacimiento" />
                            <p:calendar id="fecha" value="#{usuario.fechaNacimiento}" navigator="true" 
                                        maxdate="#{usuario.today}" yearRange="c-80:c" required="true"
                                        requiredMessage="Valor requerido"/>
                            <p:message for="fecha" />
                        </h:panelGrid>
                    </p:panel>

                    <p:panel id="domiciliosPanel" header="Domicilios" >
                        <h:panelGrid columns="3" >
                            <h:outputLabel value="Pais" />
                            <p:selectOneMenu id="pais" value="#{usuario.paisSeleccionado}" required="true"
                                             requiredMessage="Valor requerido" >
                                <f:selectItem itemLabel="Seleccione un pais" itemValue="" noSelectionOption="true" />
                                <f:selectItems value="#{usuario.paises}" />
                                <p:ajax event="change" update="provincia growl" process="@this"
                                        listener="#{usuario.actualizarProvincias}" />
                            </p:selectOneMenu>
                            <p:message for="pais" />
                            <h:outputLabel value="Provincia" />
                            <p:selectOneMenu id="provincia" value="#{usuario.provinciaSeleccionada}" 
                                             required="true" requiredMessage="Valor requerido" >
                                <f:selectItem itemLabel="Seleccione una provincia" itemValue="" />
                                <f:selectItems value="#{usuario.provincias}" />
                                <p:ajax event="change" process="@this" listener="#{usuario.prepararDomicilio}" />
                            </p:selectOneMenu>
                            <p:message for="provincia" />
                        </h:panelGrid>
                        <p:commandButton value="Agregar domicilio" type="button" 
                                         onclick="dialogoDom.show();" />
                        <p:separator />
                        <br />
                        <p:dataTable id="table" value="#{usuario.domicilios}" var="dom" >
                            <f:facet name="header" >
                                Domicilios cargados
                            </f:facet>

                            <p:column headerText="Calle" >
                                <p:cellEditor>
                                    <f:facet name="output" >
                                        <h:outputText value="#{dom.calle}" />
                                    </f:facet>
                                    <f:facet name="input" >
                                        <p:inputText value="#{dom.calle}" required="true" />
                                    </f:facet>
                                </p:cellEditor>
                            </p:column>

                            <p:column headerText="Numero" >
                                <p:cellEditor>
                                    <f:facet name="output" >
                                        <h:outputText value="#{dom.numero}" />
                                    </f:facet>
                                    <f:facet name="input" >
                                        <p:inputText value="#{dom.numero}" required="true" />
                                    </f:facet>
                                </p:cellEditor>
                            </p:column>

                            <p:column headerText="Piso" >
                                <p:cellEditor>
                                    <f:facet name="output" >
                                        <h:outputText value="#{dom.piso}" />
                                    </f:facet>
                                    <f:facet name="input" >
                                        <p:inputText value="#{dom.piso}" />
                                    </f:facet>
                                </p:cellEditor>
                            </p:column>

                            <p:column headerText="Depto" >
                                <p:cellEditor>
                                    <f:facet name="output" >
                                        <h:outputText value="#{dom.depto}" />
                                    </f:facet>
                                    <f:facet name="input" >
                                        <p:inputText value="#{dom.depto}" />
                                    </f:facet>
                                </p:cellEditor>
                            </p:column>

                            <p:column headerText="Barrio" >
                                <p:cellEditor>
                                    <f:facet name="output" >
                                        <h:outputText value="#{dom.barrio}" />
                                    </f:facet>
                                    <f:facet name="input" >
                                        <p:inputText value="#{dom.barrio}" required="true" />
                                    </f:facet>
                                </p:cellEditor>
                            </p:column>

                            <p:column headerText="Ciudad" >
                                <p:cellEditor>
                                    <f:facet name="output" >
                                        <h:outputText value="#{dom.ciudad}" />
                                    </f:facet>
                                    <f:facet name="input" >
                                        <p:inputText value="#{dom.ciudad}" required="true" />
                                    </f:facet>
                                </p:cellEditor>
                            </p:column>

                            <p:column headerText="Opciones" >
                                <p:rowEditor />
                                <p:commandButton update="table" oncomplete="confirmacion.show()" 
                                                 process="domiciliosPanel" image="ui-icon ui-icon-trash" 
                                                 title="Quitar" >
                                    <f:setPropertyActionListener value="#{dom}" target="#{usuario.domicilioSeleccionado}" />
                                </p:commandButton>
                            </p:column>
                        </p:dataTable>

                        <p:confirmDialog message="Esta seguro?" width="200" header="Confirmar"
                                         severity="alert" widgetVar="confirmacion" >
                            <p:commandButton value="Si" update="table" actionListener="#{usuario.borrarDomicilio}"
                                             oncomplete="confirmacion.hide()" process="domiciliosPanel" />
                            <p:commandButton value="No" onclick="confirmacion.hide()" type="button" />
                        </p:confirmDialog>

                    </p:panel>

                    <p:commandButton value="Crear" action="#{usuario.crearUsuario}" 
                                     ajax="false" />
                    <p:commandButton  type="reset" value="Limpiar" />
                    <p:growl id="growl" showDetail="true" globalOnly="true" />

                </h:form>

                <p:dialog id="dialogo" header="Agregar Domicilio" widgetVar="dialogoDom" >
                    <h:form id="domDialog">
                        <h:panelGrid columns="3" >
                            <h:outputLabel value="Calle" />
                            <p:inputText id="dir" value="#{usuario.calle}" required="true"
                                         requiredMessage="Valor requerido"/>
                            <p:message for="dir" />
                            <h:outputLabel value="Numero" />
                            <p:inputText id="numero" value="#{usuario.numero}" required="true"
                                         requiredMessage="Valor requerido"/>
                            <p:message for="numero" />
                            <h:outputLabel value="Piso" />
                            <p:inputText value="#{usuario.piso}" />
                            <p/>
                            <h:outputLabel value="Depto" />
                            <p:inputText value="#{usuario.depto}" />
                            <p/>
                            <h:outputLabel value="Barrio" />
                            <p:inputText id="barrio" value="#{usuario.barrio}" required="true"
                                         requiredMessage="Valor requerido"/>
                            <p:message for="barrio" />
                            <h:outputLabel value="Ciudad" />
                            <p:inputText id="ciudad" value="#{usuario.ciudad}" required="true"
                                         requiredMessage="Valor requerido"/>
                            <p:message for="ciudad" />
                            <f:facet name="footer" >
                                <p:commandButton value="Agregar" actionListener="#{usuario.agregarDomicilio}"
                                                 oncomplete="handleAgregarDomicilio(xhr, status, args)"
                                                 update="@domDialog :usuarioForm:table :usuarioForm:growl"/>
                                <p:commandButton value="Limpiar" type="reset" />
                            </f:facet>
                        </h:panelGrid>
                    </h:form>
                </p:dialog>

            </ui:define>

        </ui:composition>

    </body>
</html>
